<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pokémon Set Tracker</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%23fff' stroke='%23222' stroke-width='4'/><path d='M2 50h96' stroke='%23222' stroke-width='4'/><path d='M50 2a48 48 0 0 1 0 96' fill='%23fff'/><path d='M50 2a48 48 0 0 0 0 96' fill='%23fff'/><path d='M2 50a48 48 0 0 1 96 0' fill='%23e8594e'/><circle cx='50' cy='50' r='16' fill='%23fff' stroke='%23222' stroke-width='4'/><circle cx='50' cy='50' r='8' fill='%23222'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Anybody:wght@400;700;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0e14;
    --surface: #14171f;
    --border: #252a38;
    --text: #e8eaf0;
    --text-dim: #8890a4;
    --accent: #f6c833;
    --accent-glow: rgba(246, 200, 51, 0.15);
    --red: #e8594e;
    --blue: #4e8ee8;
    --green: #4ec87e;
    --green-glow: rgba(78, 200, 126, 0.15);
    --radius: 14px;
    --card-img-unowned: 0.45;
    --grid-line: rgba(246,200,51,0.02);
    --owned-bg: rgba(78,200,126,0.06);
    --owned-border: rgba(78,200,126,0.4);
    --chip-bg: rgba(255,255,255,0.04);
    --chip-border: rgba(255,255,255,0.06);
  }

  :root.light {
    --bg: #f4f5f7;
    --surface: #ffffff;
    --border: #dde0e6;
    --text: #1a1c22;
    --text-dim: #6b7280;
    --accent: #d4a017;
    --accent-glow: rgba(212, 160, 23, 0.12);
    --red: #dc3545;
    --blue: #2b6cb0;
    --green: #2f9e5a;
    --green-glow: rgba(47, 158, 90, 0.1);
    --card-img-unowned: 0.55;
    --grid-line: rgba(0,0,0,0.03);
    --owned-bg: rgba(47,158,90,0.08);
    --owned-border: rgba(47,158,90,0.4);
    --chip-bg: rgba(0,0,0,0.04);
    --chip-border: rgba(0,0,0,0.08);
  }

  /* Theme toggle */
  .theme-toggle {
    position:fixed; top:16px; right:16px; z-index:50;
    width:44px; height:44px; border-radius:50%;
    background:var(--surface); border:1px solid var(--border);
    cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition:all 0.3s ease; color:var(--text-dim);
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
  }
  .theme-toggle:hover { border-color:var(--accent); color:var(--accent); transform:scale(1.1); }
  .theme-toggle svg { width:20px; height:20px; transition:transform 0.3s ease; }
  .theme-toggle:hover svg { transform:rotate(30deg); }
  .theme-toggle .icon-sun, .theme-toggle .icon-moon { display:none; }
  :root:not(.light) .theme-toggle .icon-sun { display:block; }
  :root.light .theme-toggle .icon-moon { display:block; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; transition:background 0.3s ease, color 0.3s ease; }
  body::before {
    content:''; position:fixed; inset:0;
    background-image:linear-gradient(var(--grid-line) 1px,transparent 1px),linear-gradient(90deg,var(--grid-line) 1px,transparent 1px);
    background-size:60px 60px; pointer-events:none; z-index:0;
  }
  .app { position:relative; z-index:1; }

  header { padding:48px 32px 32px; text-align:center; position:relative; }
  header::after { content:''; position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:min(700px,80%); height:1px; background:linear-gradient(90deg,transparent,var(--border),transparent); }
  .logo-badge { display:inline-flex; align-items:center; gap:8px; background:var(--surface); border:1px solid var(--border); border-radius:100px; padding:6px 16px 6px 8px; font-size:12px; color:var(--text-dim); margin-bottom:20px; letter-spacing:0.5px; text-transform:uppercase; }
  .logo-badge .dot { width:8px; height:8px; background:var(--green); border-radius:50%; animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  h1 { font-family:'Anybody',sans-serif; font-weight:900; font-size:clamp(2.4rem,5vw,4rem); letter-spacing:-1px; line-height:1.1; margin-bottom:12px; }
  h1 .highlight { background:linear-gradient(135deg,var(--accent),#ff9d4e); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
  .subtitle { color:var(--text-dim); font-size:16px; max-width:500px; margin:0 auto; line-height:1.6; }

  .collection-banner { max-width:1400px; margin:28px auto 0; padding:0 32px; display:flex; gap:12px; flex-wrap:wrap; }
  .stat-card { flex:1; min-width:120px; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px 20px; text-align:center; transition:background 0.3s, border-color 0.3s; }
  .stat-card .stat-value { font-family:'Anybody',sans-serif; font-weight:900; font-size:28px; line-height:1.2; }
  .stat-card .stat-value.gold { color:var(--accent); }
  .stat-card .stat-value.green { color:var(--green); }
  .stat-card .stat-value.blue { color:var(--blue); }
  .stat-card .stat-label { font-size:12px; color:var(--text-dim); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px; }

  .data-bar { max-width:1400px; margin:16px auto 0; padding:0 32px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .data-btn { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:8px 14px; color:var(--text-dim); cursor:pointer; font-family:inherit; font-size:12px; transition:all 0.2s; display:flex; align-items:center; gap:5px; }
  .data-btn:hover { border-color:var(--accent); color:var(--text); }
  .data-btn.danger:hover { border-color:var(--red); color:var(--red); }

  .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--green); color:#0c0e14; padding:12px 24px; border-radius:10px; font-weight:600; font-size:14px; z-index:300; transition:transform 0.3s ease; pointer-events:none; }
  .toast.show { transform:translateX(-50%) translateY(0); }

  .controls { max-width:1400px; margin:24px auto; padding:0 32px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
  .search-box { flex:1; min-width:240px; position:relative; }
  .search-box svg { position:absolute; left:16px; top:50%; transform:translateY(-50%); color:var(--text-dim); width:18px; height:18px; }
  .search-box input { width:100%; padding:12px 16px 12px 44px; background:var(--surface); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:border-color 0.2s,box-shadow 0.2s; }
  .search-box input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
  .search-box input::placeholder { color:var(--text-dim); }
  .stats-pill { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 20px; font-size:13px; color:var(--text-dim); white-space:nowrap; }
  .stats-pill strong { color:var(--accent); font-weight:700; }
  .filter-btn, .sort-btn { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:12px 18px; color:var(--text-dim); cursor:pointer; font-family:inherit; font-size:13px; transition:all 0.2s; display:flex; align-items:center; gap:6px; }
  .filter-btn:hover, .sort-btn:hover { border-color:var(--accent); color:var(--text); }
  .filter-btn.active, .sort-btn.active { border-color:var(--accent); color:var(--accent); background:var(--accent-glow); }
  .grid-filter-btns { display:flex; gap:4px; }

  .grid { max-width:1400px; margin:0 auto; padding:0 32px 80px; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; }
  .set-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; cursor:pointer; transition:all 0.25s ease; position:relative; overflow:hidden; display:flex; flex-direction:column; gap:14px; }
  .set-card.animate { animation:fadeUp 0.4s ease both; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  .set-card:hover { border-color:var(--accent); transform:translateY(-4px); box-shadow:0 12px 40px rgba(0,0,0,0.4),0 0 0 1px var(--accent),0 0 30px var(--accent-glow); }
  .set-card-top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
  .set-card-logo { height:40px; max-width:180px; object-fit:contain; filter:brightness(1.1); }
  .logo-placeholder { height:40px; width:40px; display:flex; align-items:center; justify-content:center; opacity:0.25; }
  .logo-placeholder svg { width:32px; height:32px; }
  .set-card-symbol { width:28px; height:28px; object-fit:contain; flex-shrink:0; opacity:0.7; }
  .set-card-name { font-family:'Anybody',sans-serif; font-weight:700; font-size:17px; line-height:1.3; }
  .set-card-id { font-size:12px; color:var(--text-dim); font-family:monospace; letter-spacing:0.5px; text-transform:uppercase; }
  .set-card-counts { display:flex; gap:8px; flex-wrap:wrap; }
  .count-chip { font-size:11px; padding:4px 10px; border-radius:6px; background:var(--chip-bg); border:1px solid var(--chip-border); color:var(--text-dim); font-weight:500; }
  .count-chip strong { color:var(--text); font-weight:600; }
  .count-chip.total { background:var(--accent-glow); border-color:rgba(246,200,51,0.2); color:var(--accent); }
  .count-chip.total strong { color:var(--accent); }
  .count-chip.owned { background:var(--green-glow); border-color:rgba(78,200,126,0.2); color:var(--green); }
  .count-chip.owned strong { color:var(--green); }
  .progress-bar-bg { width:100%; height:6px; background:var(--chip-border); border-radius:3px; overflow:hidden; margin-top:auto; }
  .progress-bar-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--green),#66e6a0); transition:width 0.4s ease; }
  .progress-bar-fill.complete { background:linear-gradient(90deg,var(--accent),#ffe066); }

  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(6px); z-index:100; align-items:center; justify-content:center; padding:24px; }
  .modal-overlay.active { display:flex; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:18px; max-width:900px; width:100%; max-height:85vh; overflow-y:auto; padding:32px; position:relative; animation:modalIn 0.3s ease; }
  @keyframes modalIn { from{opacity:0;transform:scale(0.95) translateY(10px)} to{opacity:1;transform:scale(1) translateY(0)} }
  .modal-close { position:absolute; top:16px; right:16px; width:36px; height:36px; border-radius:50%; background:var(--chip-bg); border:1px solid var(--border); color:var(--text-dim); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; transition:all 0.2s; z-index:2; }
  .modal-close:hover { background:var(--red); color:white; border-color:var(--red); }
  .modal-header { display:flex; align-items:center; gap:16px; margin-bottom:16px; flex-wrap:wrap; }
  .modal-header img { height:50px; object-fit:contain; }
  .modal-header h2 { font-family:'Anybody',sans-serif; font-weight:900; font-size:24px; }
  .modal-toolbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid var(--border); }
  .modal-toolbar .progress-text { font-size:14px; color:var(--text-dim); }
  .modal-toolbar .progress-text strong { color:var(--green); }
  .modal-toolbar .modal-progress-bar { flex:1; min-width:80px; height:8px; background:var(--chip-border); border-radius:4px; overflow:hidden; }
  .modal-toolbar .modal-progress-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--green),#66e6a0); transition:width 0.3s ease; }
  .modal-toolbar .modal-progress-fill.complete { background:linear-gradient(90deg,var(--accent),#ffe066); }
  .check-all-btn, .modal-filter-btn { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:7px 14px; color:var(--text-dim); cursor:pointer; font-family:inherit; font-size:12px; transition:all 0.2s; }
  .check-all-btn:hover { border-color:var(--green); color:var(--green); }
  .modal-filter-btns { display:flex; gap:4px; }
  .modal-filter-btn { padding:5px 10px; border-radius:6px; font-size:11px; background:transparent; }
  .modal-filter-btn:hover { border-color:var(--accent); color:var(--text); }
  .modal-filter-btn.active { border-color:var(--accent); color:var(--accent); background:var(--accent-glow); }

  .modal-cards-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; margin-top:12px; }
  .modal-card-item { text-align:center; padding:8px; border-radius:10px; background:var(--chip-bg); border:1px solid var(--chip-border); transition:all 0.2s; cursor:pointer; position:relative; user-select:none; }
  .modal-card-item:hover { border-color:var(--border); background:var(--chip-bg); }
  .modal-card-item.owned { border-color:var(--owned-border); background:var(--owned-bg); }
  .modal-card-item.owned::after { content:'\2713'; position:absolute; top:6px; right:6px; width:22px; height:22px; background:var(--green); color:#0c0e14; border-radius:50%; font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(78,200,126,0.4); }
  .modal-card-item:not(.owned) .card-img { opacity:var(--card-img-unowned); filter:grayscale(0.4); }
  .modal-card-item.owned .card-img { opacity:1; filter:none; }
  .card-img { width:100%; border-radius:6px; aspect-ratio:3/4.2; object-fit:cover; background:var(--chip-bg); transition:opacity 0.2s,filter 0.2s; }
  .modal-card-item .card-label { font-size:11px; margin-top:6px; color:var(--text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .modal-card-item .card-local-id { font-size:10px; color:var(--text-dim); opacity:0.5; font-family:monospace; }

  .modal-loading { text-align:center; padding:40px; color:var(--text-dim); }
  .spinner { width:32px; height:32px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 12px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .loading-state { text-align:center; padding:80px 32px; }
  .empty-state { text-align:center; padding:60px 32px; color:var(--text-dim); grid-column:1/-1; font-size:15px; }
  #importInput { display:none; }

  @media (max-width:600px) {
    header { padding:32px 20px 24px; }
    .collection-banner,.data-bar,.controls { padding:0 20px; }
    .grid { padding:0 20px 60px; grid-template-columns:1fr; }
    .modal { padding:20px; }
    .stat-card { min-width:80px; }
    .stat-card .stat-value { font-size:22px; }
  }
</style>
</head>
<body>
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
  <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
  <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
</button>
<div class="app">
  <header>
    <div class="logo-badge"><span class="dot"></span> Pokémon Set Tracker</div>
    <h1>Pokémon <span class="highlight">Set Tracker</span></h1>
    <p class="subtitle">Browse sets, click cards to mark them as owned. Everything is saved locally in your browser.</p>
  </header>
  <div class="collection-banner">
    <div class="stat-card"><div class="stat-value gold" id="statTotalCards">0</div><div class="stat-label">Cards Owned</div></div>
    <div class="stat-card"><div class="stat-value green" id="statSetsStarted">0</div><div class="stat-label">Sets Started</div></div>
    <div class="stat-card"><div class="stat-value blue" id="statSetsComplete">0</div><div class="stat-label">Sets Complete</div></div>
  </div>
  <div class="data-bar">
    <button class="data-btn" onclick="exportCollection()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export
    </button>
    <button class="data-btn" onclick="document.getElementById('importInput').click()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import
    </button>
    <input type="file" id="importInput" accept=".json" onchange="importCollection(event)">
    <button class="data-btn danger" onclick="clearCollection()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>Clear All
    </button>
    <button class="data-btn" onclick="exportProgressImage()" style="margin-left:auto">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>Share Progress
    </button>
  </div>
  <div class="controls">
    <div class="search-box">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="Search sets by name or ID…">
    </div>
    <div class="stats-pill" id="statsPill">Loading…</div>
    <div class="grid-filter-btns">
      <button class="modal-filter-btn active" id="gfAll" onclick="setGridFilter('all')">All</button>
      <button class="modal-filter-btn" id="gfStarted" onclick="setGridFilter('started')">Started</button>
      <button class="modal-filter-btn" id="gfComplete" onclick="setGridFilter('complete')">Complete</button>
    </div>
    <button class="sort-btn active" onclick="toggleSort()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7-7 7 7"/></svg>
      <span id="sortLabel">A → Z</span>
    </button>
  </div>
  <div class="grid" id="grid">
    <div class="loading-state"><div class="spinner"></div><p>Fetching sets from TCGdex…</p></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal(event,true)">&#x2715;</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
// ── Theme ──
(function() {
  var saved = localStorage.getItem('pokemon_tcg_theme');
  if (saved === 'light') document.documentElement.classList.add('light');
})();
function toggleTheme() {
  var isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('pokemon_tcg_theme', isLight ? 'light' : 'dark');
}

var API = 'https://api.tcgdex.net/v2/en';
var STORAGE_KEY = 'pokemon_tcg_collection';
var allSets = [];
var sortAZ = true;
var isFirstRender = true;
var currentModalSetId = null;
var currentModalFilter = 'all';
var gridFilter = 'all';
var setCardsCache = {};
var refreshTimer = null;

// Placeholder for failed card images
var CARD_PLACEHOLDER = (function() {
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="300" height="420">' +
    '<rect width="300" height="420" rx="16" fill="%231a1e2a"/>' +
    '<rect x="8" y="8" width="284" height="404" rx="12" fill="none" stroke="%23252a38" stroke-width="2"/>' +
    '<circle cx="150" cy="180" r="50" fill="none" stroke="%23333a4d" stroke-width="3"/>' +
    '<line x1="100" y1="180" x2="200" y2="180" stroke="%23333a4d" stroke-width="3"/>' +
    '<circle cx="150" cy="180" r="12" fill="%23333a4d"/>' +
    '<circle cx="150" cy="180" r="6" fill="%231a1e2a"/>' +
    '<text x="150" y="270" text-anchor="middle" fill="%23444c60" font-family="sans-serif" font-size="13">No image</text>' +
    '</svg>';
  return 'data:image/svg+xml,' + svg;
})();

function onCardImgError(img) {
  if (!img._failed) { img._failed = true; img.src = CARD_PLACEHOLDER; }
}

var LOGO_PLACEHOLDER_HTML = '<div class="logo-placeholder"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="46" fill="none" stroke="currentColor" stroke-width="5"/><line x1="4" y1="50" x2="96" y2="50" stroke="currentColor" stroke-width="5"/><circle cx="50" cy="50" r="12" fill="none" stroke="currentColor" stroke-width="5"/></svg></div>';

function onLogoError(img) {
  var div = document.createElement('div');
  div.innerHTML = LOGO_PLACEHOLDER_HTML;
  img.replaceWith(div.firstChild);
}

// ── Collection: simple { cardId: timestamp } ──
function getCollection() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e) { return {}; }
}
function saveCollection(col) { localStorage.setItem(STORAGE_KEY, JSON.stringify(col)); }

function isCardOwned(cardId) { return !!getCollection()[cardId]; }

function toggleOwned(cardId) {
  var col = getCollection();
  if (col[cardId]) { delete col[cardId]; } else { col[cardId] = Date.now(); }
  saveCollection(col);
  return !!col[cardId];
}

function getOwnedInSet(setId) {
  var col = getCollection();
  var count = 0;
  for (var key in col) { if (key.startsWith(setId + '-')) count++; }
  return count;
}

// ── Toast ──
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(function() { t.classList.remove('show'); }, 2200);
}

// ── Export / Import / Clear ──
function exportCollection() {
  var col = getCollection();
  var count = Object.keys(col).length;
  if (count === 0) { showToast('Nothing to export yet!'); return; }
  var blob = new Blob([JSON.stringify(col, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'pokemon-set-tracker-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Exported ' + count + ' cards!');
}

function importCollection(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (typeof data !== 'object' || Array.isArray(data)) throw new Error('bad');
      var col = getCollection();
      var added = 0;
      for (var key in data) { if (!col[key]) { col[key] = data[key] || Date.now(); added++; } }
      saveCollection(col);
      updateGlobalStats(); render();
      if (currentModalSetId) refreshModalCards();
      showToast('Imported ' + added + ' new cards!');
    } catch(err) { showToast('Invalid file format.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearCollection() {
  var count = Object.keys(getCollection()).length;
  if (count === 0) { showToast('Already empty.'); return; }
  if (!confirm('Remove all ' + count + ' cards? This cannot be undone.')) return;
  localStorage.removeItem(STORAGE_KEY);
  updateGlobalStats(); render();
  if (currentModalSetId) refreshModalCards();
  showToast('Collection cleared.');
}

// ── Global stats ──
function updateGlobalStats() {
  var col = getCollection();
  var ownedIds = Object.keys(col);
  var totalCards = ownedIds.length;
  var setsPrefixes = {};
  for (var i = 0; i < ownedIds.length; i++) {
    var dashIdx = ownedIds[i].lastIndexOf('-');
    if (dashIdx > 0) {
      var prefix = ownedIds[i].substring(0, dashIdx);
      setsPrefixes[prefix] = (setsPrefixes[prefix] || 0) + 1;
    }
  }
  var setsStarted = Object.keys(setsPrefixes).length;
  var setsComplete = 0;
  for (var j = 0; j < allSets.length; j++) {
    var s = allSets[j];
    var total = s.cardCount ? s.cardCount.total : 0;
    if (total > 0 && (setsPrefixes[s.id] || 0) >= total) setsComplete++;
  }
  document.getElementById('statTotalCards').textContent = totalCards.toLocaleString();
  document.getElementById('statSetsStarted').textContent = setsStarted;
  document.getElementById('statSetsComplete').textContent = setsComplete;
}

// ── Init ──
async function init(retries) {
  if (retries === undefined) retries = 2;
  var grid = document.getElementById('grid');
  try {
    var res = await fetch(API + '/sets');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    var data = await res.json();
    if (!Array.isArray(data)) throw new Error('Unexpected format.');
    allSets = data;
    if (allSets.length === 0) { grid.innerHTML = '<div class="empty-state">The API returned an empty list.</div>'; return; }
    updateGlobalStats(); render();
  } catch(e) {
    if (retries > 0) {
      grid.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Retrying… (' + retries + ' left)</p></div>';
      setTimeout(function() { init(retries-1); }, 1500);
    } else {
      grid.innerHTML =
        '<div class="empty-state"><p style="font-size:18px;margin-bottom:12px">Could not load sets</p>' +
        '<p style="margin-bottom:8px"><strong>Error:</strong> ' + e.message + '</p>' +
        '<p style="margin-bottom:16px;max-width:500px;margin-left:auto;margin-right:auto">Try <strong>downloading this file</strong> and opening it in your browser.</p>' +
        '<button onclick="init(2)" style="padding:10px 24px;border-radius:8px;border:1px solid var(--accent);background:var(--accent-glow);color:var(--accent);cursor:pointer;font-family:inherit;font-size:14px;font-weight:600;">Retry</button></div>';
    }
  }
}

// ── Render set grid ──
function render() {
  var q = document.getElementById('searchInput').value.toLowerCase().trim();
  var filtered = allSets.filter(function(s) {
    return s.name.toLowerCase().indexOf(q) !== -1 || s.id.toLowerCase().indexOf(q) !== -1;
  });
  if (gridFilter !== 'all') {
    filtered = filtered.filter(function(s) {
      var total = s.cardCount ? s.cardCount.total : 0;
      var owned = getOwnedInSet(s.id);
      if (gridFilter === 'started') return owned > 0;
      if (gridFilter === 'complete') return total > 0 && owned >= total;
      return true;
    });
  }
  filtered.sort(function(a,b) { return sortAZ ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name); });
  document.getElementById('statsPill').innerHTML = 'Showing <strong>' + filtered.length + '</strong> of <strong>' + allSets.length + '</strong> sets';
  if (filtered.length === 0) {
    document.getElementById('grid').innerHTML = '<div class="empty-state">No sets found.</div>';
    return;
  }
  document.getElementById('grid').innerHTML = filtered.map(function(s, i) {
    var total = s.cardCount ? s.cardCount.total : 0;
    var owned = getOwnedInSet(s.id);
    var pct = total > 0 ? Math.round((owned/total)*100) : 0;
    var isComplete = total > 0 && owned >= total;
    return '<div class="set-card' + (isFirstRender ? ' animate' : '') + '"' +
      (isFirstRender ? ' style="animation-delay:' + Math.min(i*20,600) + 'ms"' : '') +
      ' onclick="openSet(\'' + s.id + '\')">' +
      '<div class="set-card-top">' +
        (s.logo ? '<img class="set-card-logo" src="' + s.logo + '.png" alt="' + s.name + '" loading="lazy" onerror="onLogoError(this)">' : LOGO_PLACEHOLDER_HTML) +
        (s.symbol ? '<img class="set-card-symbol" src="' + s.symbol + '.png" alt="" loading="lazy" onerror="this.style.display=\'none\'">' : '') +
      '</div><div>' +
        '<div class="set-card-name">' + s.name + '</div>' +
        '<div class="set-card-id">' + s.id + '</div>' +
      '</div><div class="set-card-counts">' +
        '<span class="count-chip total"><strong>' + (total||'?') + '</strong> total</span>' +
        (owned > 0 ? '<span class="count-chip owned"><strong>' + owned + '</strong> owned</span>' : '') +
      '</div>' +
      '<div class="progress-bar-bg"><div class="progress-bar-fill' + (isComplete ? ' complete' : '') + '" style="width:' + pct + '%"></div></div></div>';
  }).join('');
  isFirstRender = false;
}

function toggleSort() {
  sortAZ = !sortAZ;
  document.getElementById('sortLabel').textContent = sortAZ ? 'A \u2192 Z' : 'Z \u2192 A';
  render();
}

function setGridFilter(f) {
  gridFilter = f;
  document.getElementById('gfAll').classList.toggle('active', f === 'all');
  document.getElementById('gfStarted').classList.toggle('active', f === 'started');
  document.getElementById('gfComplete').classList.toggle('active', f === 'complete');
  render();
}

document.getElementById('searchInput').addEventListener('input', render);

// ── Set modal ──
async function openSet(id) {
  currentModalSetId = id;
  currentModalFilter = 'all';
  modalDirty = false;
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  var content = document.getElementById('modalContent');
  content.innerHTML = '<div class="modal-loading"><div class="spinner"></div>Loading set…</div>';
  try {
    var set;
    if (setCardsCache[id]) { set = setCardsCache[id]; }
    else { var res = await fetch(API + '/sets/' + id); set = await res.json(); setCardsCache[id] = set; }
    renderModal(set);
  } catch(e) { content.innerHTML = '<div class="modal-loading">Failed to load set.</div>'; }
}

function renderModal(set) {
  var content = document.getElementById('modalContent');
  var col = getCollection();
  var cards = set.cards || [];
  var owned = 0;
  for (var i = 0; i < cards.length; i++) { if (col[cards[i].id]) owned++; }
  var total = cards.length;
  var pct = total > 0 ? Math.round((owned/total)*100) : 0;
  var isComplete = total > 0 && owned >= total;

  var filteredCards = cards;
  if (currentModalFilter === 'owned') filteredCards = cards.filter(function(c) { return !!col[c.id]; });
  else if (currentModalFilter === 'missing') filteredCards = cards.filter(function(c) { return !col[c.id]; });

  var cardsHtml = filteredCards.map(function(c) {
    return '<div class="modal-card-item' + (col[c.id] ? ' owned' : '') + '" data-card-id="' + c.id + '" onclick="toggleCard(\'' + c.id + '\')" title="' + c.name + '">' +
      '<img class="card-img" src="' + c.image + '/low.webp" alt="' + c.name + '" loading="lazy" onerror="onCardImgError(this)">' +
      '<div class="card-label">' + c.name + '</div>' +
      '<div class="card-local-id">#' + c.localId + '</div></div>';
  }).join('');

  content.innerHTML =
    '<div class="modal-header">' +
      (set.logo ? '<img src="' + set.logo + '.png" alt="" onerror="onLogoError(this)">' : LOGO_PLACEHOLDER_HTML) +
      '<div><h2>' + set.name + '</h2>' +
      '<div class="set-card-id" style="margin-top:4px">' + set.id + (set.serie ? ' &middot; ' + set.serie.name : '') + '</div></div>' +
    '</div>' +
    '<div class="modal-toolbar">' +
      '<span class="progress-text"><strong>' + owned + '</strong> / ' + total + ' (' + pct + '%)</span>' +
      '<div class="modal-progress-bar"><div class="modal-progress-fill' + (isComplete?' complete':'') + '" style="width:' + pct + '%"></div></div>' +
      '<div class="modal-filter-btns">' +
        '<button class="modal-filter-btn' + (currentModalFilter==='all'?' active':'') + '" onclick="setModalFilter(\'all\')">All</button>' +
        '<button class="modal-filter-btn' + (currentModalFilter==='owned'?' active':'') + '" onclick="setModalFilter(\'owned\')">Owned</button>' +
        '<button class="modal-filter-btn' + (currentModalFilter==='missing'?' active':'') + '" onclick="setModalFilter(\'missing\')">Missing</button>' +
      '</div>' +
      '<button class="check-all-btn" onclick="toggleAllCards(\'' + set.id + '\')">' + (isComplete ? 'Uncheck All' : 'Check All') + '</button>' +
      '<button class="check-all-btn" onclick="exportMissingImage(\'' + set.id + '\')" style="margin-left:2px" title="Download an image of all missing cards to share">' +
        '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>Share Missing' +
      '</button>' +
    '</div>' +
    (set.releaseDate ? '<p style="font-size:13px;color:var(--text-dim);margin-bottom:8px">Released: ' + set.releaseDate + '</p>' : '') +
    '<div class="modal-cards-grid">' +
      (filteredCards.length > 0 ? cardsHtml : '<p style="color:var(--text-dim);grid-column:1/-1;text-align:center;padding:24px">No cards match this filter.</p>') +
    '</div>';
}

function refreshModalCards() {
  if (!currentModalSetId || !setCardsCache[currentModalSetId]) return;
  renderModal(setCardsCache[currentModalSetId]);
}
function setModalFilter(f) { currentModalFilter = f; refreshModalCards(); }

var modalDirty = false;

function toggleCard(cardId) {
  var nowOwned = toggleOwned(cardId);
  modalDirty = true;
  var el = document.querySelector('[data-card-id="' + cardId + '"]');
  if (el) { if (nowOwned) el.classList.add('owned'); else el.classList.remove('owned'); }
  updateGlobalStats();
  updateModalStats();
}

function updateModalStats() {
  if (!currentModalSetId || !setCardsCache[currentModalSetId]) return;
  var set = setCardsCache[currentModalSetId];
  var col = getCollection();
  var cards = set.cards || [];
  var owned = 0;
  for (var i = 0; i < cards.length; i++) { if (col[cards[i].id]) owned++; }
  var total = cards.length;
  var pct = total > 0 ? Math.round((owned/total)*100) : 0;
  var isComplete = total > 0 && owned >= total;
  var pt = document.querySelector('.progress-text');
  if (pt) pt.innerHTML = '<strong>' + owned + '</strong> / ' + total + ' (' + pct + '%)';
  var pf = document.querySelector('.modal-progress-fill');
  if (pf) {
    pf.style.width = pct + '%';
    if (isComplete) pf.classList.add('complete'); else pf.classList.remove('complete');
  }
  var cab = document.querySelector('.check-all-btn');
  if (cab) cab.textContent = isComplete ? 'Uncheck All' : 'Check All';
}

function toggleAllCards(setId) {
  var set = setCardsCache[setId];
  if (!set || !set.cards) return;
  var col = getCollection();
  var allOwned = set.cards.every(function(c) { return !!col[c.id]; });
  if (allOwned) { set.cards.forEach(function(c) { delete col[c.id]; }); }
  else { set.cards.forEach(function(c) { if (!col[c.id]) col[c.id] = Date.now(); }); }
  saveCollection(col);
  modalDirty = true;
  updateGlobalStats(); refreshModalCards();
  showToast(allOwned ? 'Cleared ' + set.name : 'Marked all as owned!');
}

// ── Export missing cards as image ──
async function exportMissingImage(setId) {
  var set = setCardsCache[setId];
  if (!set || !set.cards) return;
  var col = getCollection();
  var missing = set.cards.filter(function(c) { return !col[c.id]; });

  if (missing.length === 0) {
    showToast('You own every card in this set!');
    return;
  }

  showToast('Generating image… (' + missing.length + ' cards)');

  // Layout config
  var cols = Math.min(missing.length, 8);
  var rows = Math.ceil(missing.length / cols);
  var cardW = 140;
  var cardH = 196;
  var pad = 12;
  var headerH = 80;
  var footerH = 40;
  var canvasW = pad + cols * (cardW + pad);
  var canvasH = headerH + pad + rows * (cardH + 28 + pad) + footerH;

  var canvas = document.createElement('canvas');
  canvas.width = canvasW;
  canvas.height = canvasH;
  var ctx = canvas.getContext('2d');

  // Background
  ctx.fillStyle = '#0c0e14';
  ctx.fillRect(0, 0, canvasW, canvasH);

  // Header
  ctx.fillStyle = '#f6c833';
  ctx.font = 'bold 22px sans-serif';
  ctx.fillText(set.name + ' — Missing Cards', pad + 4, 36);
  ctx.fillStyle = '#8890a4';
  ctx.font = '14px sans-serif';
  ctx.fillText(missing.length + ' of ' + set.cards.length + ' cards needed', pad + 4, 58);

  // Load all card images in parallel
  var images = await Promise.all(missing.map(function(c) {
    return new Promise(function(resolve) {
      var img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function() { resolve({ img: img, card: c, ok: true }); };
      img.onerror = function() { resolve({ img: null, card: c, ok: false }); };
      img.src = c.image + '/low.png';
    });
  }));

  // Draw cards
  for (var i = 0; i < images.length; i++) {
    var col2 = i % cols;
    var row = Math.floor(i / cols);
    var x = pad + col2 * (cardW + pad);
    var y = headerH + pad + row * (cardH + 28 + pad);

    // Card background
    ctx.fillStyle = '#14171f';
    roundRect(ctx, x, y, cardW, cardH, 8);
    ctx.fill();
    ctx.strokeStyle = '#252a38';
    ctx.lineWidth = 1;
    roundRect(ctx, x, y, cardW, cardH, 8);
    ctx.stroke();

    if (images[i].ok) {
      // Draw image maintaining aspect ratio
      var img = images[i].img;
      var scale = Math.min(cardW / img.width, cardH / img.height);
      var iw = img.width * scale;
      var ih = img.height * scale;
      ctx.save();
      roundRect(ctx, x, y, cardW, cardH, 8);
      ctx.clip();
      ctx.drawImage(img, x + (cardW - iw) / 2, y + (cardH - ih) / 2, iw, ih);
      ctx.restore();
    } else {
      // Placeholder
      ctx.fillStyle = '#252a38';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('No image', x + cardW / 2, y + cardH / 2 + 4);
      ctx.textAlign = 'left';
    }

    // Card name below
    ctx.fillStyle = '#e8eaf0';
    ctx.font = '11px sans-serif';
    ctx.textAlign = 'center';
    var name = images[i].card.name;
    if (ctx.measureText(name).width > cardW) {
      name = name.substring(0, 16) + '…';
    }
    ctx.fillText(name, x + cardW / 2, y + cardH + 16);
    ctx.fillStyle = '#555';
    ctx.font = '10px monospace';
    ctx.fillText('#' + images[i].card.localId, x + cardW / 2, y + cardH + 28);
    ctx.textAlign = 'left';
  }

  // Footer
  ctx.fillStyle = '#333a4d';
  ctx.font = '11px sans-serif';
  ctx.fillText('Generated by Pokémon Set Tracker', pad + 4, canvasH - 14);

  // Download
  canvas.toBlob(function(blob) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = set.id + '-missing-cards.png';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Image saved!');
  }, 'image/png');
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// ── Export collection progress as image ──
async function exportProgressImage() {
  var col = getCollection();
  var startedSets = [];
  for (var i = 0; i < allSets.length; i++) {
    var s = allSets[i];
    var total = s.cardCount ? s.cardCount.total : 0;
    var owned = getOwnedInSet(s.id);
    if (owned > 0) {
      startedSets.push({ name: s.name, id: s.id, owned: owned, total: total, logo: s.logo || null });
    }
  }

  if (startedSets.length === 0) {
    showToast('No sets started yet!');
    return;
  }

  showToast('Generating progress image…');

  startedSets.sort(function(a, b) {
    return (b.owned / b.total) - (a.owned / a.total);
  });

  // Load all logos in parallel
  var logoImages = await Promise.all(startedSets.map(function(s) {
    return new Promise(function(resolve) {
      if (!s.logo) { resolve(null); return; }
      var img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function() { resolve(img); };
      img.onerror = function() { resolve(null); };
      img.src = s.logo + '.png';
    });
  }));

  // Layout
  var pad = 24;
  var logoW = 120;
  var logoH = 32;
  var logoGap = 8;
  var textX = pad + logoW + logoGap; // text starts after logo area
  var rowH = 52;
  var headerH = 100;
  var footerH = 40;
  var canvasW = 700;
  var canvasH = headerH + startedSets.length * rowH + pad + footerH;

  var canvas = document.createElement('canvas');
  canvas.width = canvasW;
  canvas.height = canvasH;
  var ctx = canvas.getContext('2d');

  // Background
  ctx.fillStyle = '#0c0e14';
  ctx.fillRect(0, 0, canvasW, canvasH);

  // Header
  ctx.fillStyle = '#f6c833';
  ctx.font = 'bold 26px sans-serif';
  ctx.fillText('My Pokémon Collection', pad, pad + 30);

  var totalOwned = Object.keys(col).length;
  var complete = 0;
  for (var j = 0; j < startedSets.length; j++) {
    if (startedSets[j].owned >= startedSets[j].total) complete++;
  }
  ctx.fillStyle = '#8890a4';
  ctx.font = '14px sans-serif';
  ctx.fillText(totalOwned + ' cards owned  |  ' + startedSets.length + ' sets started  |  ' + complete + ' sets complete', pad, pad + 56);

  // Divider
  ctx.strokeStyle = '#252a38';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, headerH - 10);
  ctx.lineTo(canvasW - pad, headerH - 10);
  ctx.stroke();

  // Set rows
  var barW = 220;
  var barH = 14;
  var barX = canvasW - pad - barW;

  for (var k = 0; k < startedSets.length; k++) {
    var s2 = startedSets[k];
    var y = headerH + k * rowH;
    var pct = s2.total > 0 ? s2.owned / s2.total : 0;
    var isComplete = pct >= 1;
    var logo = logoImages[k];
    var nameX = textX;

    // Draw logo
    if (logo) {
      var scale = Math.min(logoW / logo.width, logoH / logo.height);
      var lw = logo.width * scale;
      var lh = logo.height * scale;
      var ly = y + (rowH - lh) / 2 - 2;
      ctx.drawImage(logo, pad, ly, lw, lh);
    } else {
      // No logo — just use set name in logo area
      nameX = pad;
    }

    // Set name
    ctx.fillStyle = '#e8eaf0';
    ctx.font = '14px sans-serif';
    var displayName = s2.name;
    var maxNameW = barX - nameX - 60;
    while (ctx.measureText(displayName).width > maxNameW && displayName.length > 3) {
      displayName = displayName.substring(0, displayName.length - 2) + '…';
    }
    ctx.fillText(displayName, nameX, y + 22);

    // Set ID
    ctx.fillStyle = '#555';
    ctx.font = '10px monospace';
    ctx.fillText(s2.id, nameX, y + 38);

    // Progress bar background
    ctx.fillStyle = '#1a1e2a';
    roundRect(ctx, barX, y + 10, barW, barH, 7);
    ctx.fill();
    ctx.strokeStyle = '#252a38';
    ctx.lineWidth = 1;
    roundRect(ctx, barX, y + 10, barW, barH, 7);
    ctx.stroke();

    // Progress bar fill
    if (pct > 0) {
      var fillW = Math.max(barH, barW * pct);
      ctx.fillStyle = isComplete ? '#f6c833' : '#4ec87e';
      roundRect(ctx, barX, y + 10, Math.min(fillW, barW), barH, 7);
      ctx.fill();
    }

    // Percentage text
    ctx.fillStyle = isComplete ? '#f6c833' : '#e8eaf0';
    ctx.font = 'bold 13px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(pct * 100) + '%', barX - 8, y + 23);
    ctx.textAlign = 'left';

    // Count
    ctx.fillStyle = '#555';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(s2.owned + '/' + s2.total, barX - 8, y + 38);
    ctx.textAlign = 'left';

    // Row divider
    if (k < startedSets.length - 1) {
      ctx.strokeStyle = '#1a1e2a';
      ctx.beginPath();
      ctx.moveTo(pad, y + rowH - 2);
      ctx.lineTo(canvasW - pad, y + rowH - 2);
      ctx.stroke();
    }
  }

  // Footer
  ctx.fillStyle = '#333a4d';
  ctx.font = '11px sans-serif';
  ctx.fillText('Generated by Pokémon Set Tracker  •  ' + new Date().toLocaleDateString(), pad, canvasH - 14);

  canvas.toBlob(function(blob) {
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'pokemon-collection-progress-' + new Date().toISOString().slice(0,10) + '.png';
    a.click();
    URL.revokeObjectURL(url);
    showToast('Progress image saved!');
  }, 'image/png');
}

function closeModal(e, force) {
  if (force || e.target === document.getElementById('modalOverlay')) {
    document.getElementById('modalOverlay').classList.remove('active');
    document.body.style.overflow = '';
    // Surgically update just the affected set card instead of full re-render
    if (modalDirty && currentModalSetId) {
      updateSetCard(currentModalSetId);
      modalDirty = false;
    }
    currentModalSetId = null;
  }
}

function updateSetCard(setId) {
  // Find the set card in the grid by matching the onclick
  var allCards = document.querySelectorAll('.set-card');
  var setData = null;
  for (var i = 0; i < allSets.length; i++) {
    if (allSets[i].id === setId) { setData = allSets[i]; break; }
  }
  if (!setData) return;
  var total = setData.cardCount ? setData.cardCount.total : 0;
  var owned = getOwnedInSet(setId);
  var pct = total > 0 ? Math.round((owned / total) * 100) : 0;
  var isComplete = total > 0 && owned >= total;

  for (var j = 0; j < allCards.length; j++) {
    var card = allCards[j];
    var onclick = card.getAttribute('onclick');
    if (onclick && onclick.indexOf("'" + setId + "'") !== -1) {
      // Update owned chip
      var countsEl = card.querySelector('.set-card-counts');
      if (countsEl) {
        var ownedChip = countsEl.querySelector('.count-chip.owned');
        if (owned > 0) {
          if (ownedChip) {
            ownedChip.innerHTML = '<strong>' + owned + '</strong> owned';
          } else {
            countsEl.insertAdjacentHTML('beforeend', '<span class="count-chip owned"><strong>' + owned + '</strong> owned</span>');
          }
        } else if (ownedChip) {
          ownedChip.remove();
        }
      }
      // Update progress bar
      var fill = card.querySelector('.progress-bar-fill');
      if (fill) {
        fill.style.width = pct + '%';
        if (isComplete) fill.classList.add('complete'); else fill.classList.remove('complete');
      }
      break;
    }
  }
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal(null, true);
});

init();
</script>
</body>
</html>
